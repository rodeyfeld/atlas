variables:
  - &docker_creds
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password

steps:
  build:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: edrodefeld/atlas
      auto_tag: true
      <<: *docker_creds
    when:
      - event: [push, manual]
        branch: main

  sync-secrets:
    image: bitnami/kubectl
    environment:
      BAO_ADDR: https://cuneiform.pinwheel.fan
      BAO_TOKEN:
        from_secret: cuneiform_token
    commands:
      - |
        # Install bao CLI
        wget -q https://github.com/openbao/openbao/releases/download/v2.1.0/bao_2.1.0_linux_amd64.tar.gz
        tar -xzf bao_2.1.0_linux_amd64.tar.gz
        chmod +x bao
        
        # Fetch secrets from Cuneiform
        ./bao kv get -format=json galaxy-kv/prod/atlas > /tmp/secrets.json
        
        # Create K8s secret
        kubectl create secret generic atlas-env-secrets \
          --from-literal=POSTGRES_USER="$(cat /tmp/secrets.json | jq -r '.data.data.postgres_user')" \
          --from-literal=POSTGRES_PASSWORD="$(cat /tmp/secrets.json | jq -r '.data.data.postgres_password')" \
          -n galaxy --dry-run=client -o yaml | kubectl apply -f -
    when:
      - event: [push, manual]
        branch: main

  deploy:
    image: bitnami/kubectl
    commands:
      - kubectl rollout restart deployment/atlas -n galaxy
    when:
      - event: [push, manual]
        branch: main
